<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tragamonedas Yavalva</title>
<style>
  :root{ --txt:#f8fafc; --muted:#cbd5e1; --btn:#f59e0b; --btn2:#2f2b37; }
  html,body{height:100%}
  body{margin:0;color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background: radial-gradient(1000px 600px at 50% -120px,#2a1f46 10%,#160f25 45%,#0e0a16 90%);}
  .wrap{max-width:920px;margin:24px auto;padding:12px}
  h1{font-size:42px;margin:14px 0 6px;text-align:center}
  h1 small{display:block;font-size:14px;color:var(--muted);font-weight:500;margin-top:6px}
  .badge{display:inline-block;margin:8px auto 18px;background:#3d2f60;padding:10px 14px;border-radius:999px;font-weight:700}
  .topbar{display:flex;gap:10px;justify-content:center;align-items:center;margin:4px 0 8px;flex-wrap:wrap}
  .topbar .muted{color:var(--muted)}
  .btn{appearance:none;border:0;background:var(--btn2);color:var(--txt);padding:8px 14px;border-radius:16px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--btn); color:#1f1300; box-shadow:0 6px 20px rgba(245,158,11,.25)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .machine{background:linear-gradient(180deg,#1f1434,#140c23);border:1px solid #3b2e5f;border-radius:22px;padding:22px 20px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .reels{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:16px}
  .reel{background:#0b0713;border:1px solid #3b2e5f;border-radius:18px;display:flex;align-items:center;justify-content:center;padding:10px;aspect-ratio:1/1;box-shadow:inset 0 8px 20px rgba(0,0,0,.35)}
  .reel img{width:100%;height:100%;object-fit:contain;border-radius:14px;background:#120b1d}
  .actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .note{color:var(--muted);margin:10px 0 0;display:flex;gap:6px;align-items:center;min-height:22px}
  .note .dot{width:8px;height:8px;background:#ffd54a;border-radius:50%}
  .quota{color:var(--muted);font-size:14px;margin-left:auto}
  .rules{margin-top:18px;background:#231a38;border:1px solid #3b2e5f;border-radius:16px;overflow:hidden}
  .rules h3{margin:0;padding:14px 16px;border-bottom:1px solid #3b2e5f;font-size:16px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px 14px;text-align:left}
  tr+tr td{border-top:1px dashed #3b2e5f}
  th{color:var(--muted);font-weight:700}
  dialog{border:0;border-radius:18px;padding:0;background:#0f0b16;color:var(--txt);max-width:420px}
  dialog::backdrop{background:rgba(0,0,0,.55)}
  .card{padding:16px 18px}
  .field{display:flex;flex-direction:column;gap:6px;margin:8px 0 14px}
  input[type="text"]{background:#151025;border:1px solid #423463;border-radius:12px;color:var(--txt);padding:12px 14px;font-size:16px}
  .code{font-size:36px;font-weight:900;letter-spacing:1px;background:#1b132b;border:1px solid #3f2f63;padding:10px 12px;border-radius:12px;display:inline-block;margin-top:6px}
  .center{text-align:center}
  .big{font-size:20px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <span class="muted">Jugador:</span>
    <b id="playerName">no registrado</b>
    <button id="changeName" class="btn">Cambiar nombre</button>
    <button id="idBtn" class="btn">Mi ID</button>
  </div>

  <div class="badge">üé∞ Tragamonedas Yavalva</div>
  <h1>Gira y gana premios üéÅ<small>v6.5 UX r√°pida + reserva paralela</small></h1>

  <div class="machine" id="machine">
    <div class="reels">
      <div class="reel"><img id="r1" alt=""></div>
      <div class="reel"><img id="r2" alt=""></div>
      <div class="reel"><img id="r3" alt=""></div>
    </div>
    <div class="actions">
      <button id="spinBtn" class="btn primary">Girar</button>
      <button id="shareBtn" class="btn">Compartir</button>
      <span id="quotaText" class="quota">‚Äî</span>
    </div>
    <div class="note"><span class="dot"></span><span id="resultMsg">Sin premio, vuelve a intentarlo.</span></div>
  </div>

  <div class="rules">
    <h3>Reglas</h3>
    <table>
      <thead><tr><th>Productos en pantalla</th><th>Premio</th></tr></thead>
      <tbody>
        <tr><td>0</td><td>Sin premio</td></tr>
        <tr><td>1</td><td>Descuento del 10% (c√≥digo DESC10)</td></tr>
        <tr><td>2</td><td>1 producto de obsequio en compras &gt; $100.000 (no v√°lido para kits) (c√≥digo OBSEQ1)</td></tr>
        <tr><td>3</td><td>Descuento del 50% en tu pr√≥xima compra (c√≥digo DESC50)</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Modal nombre -->
  <dialog id="nameDlg">
    <div class="card">
      <h3 class="center">Ingresa tu nombre completo</h3>
      <div class="field">
        <label for="nameInput">Nombre</label>
        <input id="nameInput" type="text" placeholder="Ej: Ana P√©rez" />
      </div>
      <div class="center"><button id="saveName" class="btn primary">Continuar</button></div>
    </div>
  </dialog>

  <!-- Modal premio -->
  <dialog id="prizeDlg">
    <div class="card center">
      <div style="font-size:34px;margin-bottom:6px">üéâ ¬°GANASTE! üéâ</div>
      <div id="prizeText" class="big"></div>
      <div id="prizeCode" class="code"></div>
      <div style="margin-top:12px"><button id="closePrize" class="btn primary">Listo</button></div>
    </div>
  </dialog>
</div>

<script>
/* ======= Config ======= */
const PRIMARY_URL = "https://script.google.com/macros/s/AKfycbyDtfHUH0quGfb91uCgtyRvY15eMk0Iukb7l_SMs00yY7Y3ecnsJMh4QJfMqZq8ewb7/exec";
const VERSION = "v6.5";

/* S√≠mbolos (ajusta rutas si cambias im√°genes) */
const PRODUCT_IMAGE = "img/products/imgCarita3.jpg";
const FILLERS = [
  "img/fillers/imgCarita1.jpg",
  "img/fillers/imgCarita2.jpg",
  "img/fillers/imgCarita4.jpg",
  "img/fillers/imgCarita5.jpg"
];
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* Probabilidades */
function chooseProductCount(){
  const n = Math.random()*100;
  if (n < 84) return 0;
  if (n < 94) return 1;
  if (n < 99) return 2;
  return 3;
}

/* ======= Base ======= */
const NAME_KEY = "yv_player_name";
const PID_KEY  = "yv_player_id";
const $ = s => document.querySelector(s);
const qs = new URLSearchParams(location.search);

function getName(){ return localStorage.getItem(NAME_KEY) || ""; }
function setName(v){ localStorage.setItem(NAME_KEY,(v||"").trim()); paintName(); }
function paintName(){ $("#playerName").textContent = getName() || "no registrado"; }
function showNameModal(){ $("#nameInput").value = getName(); $("#nameDlg").showModal(); }

function getPlayerId(){
  let id = localStorage.getItem(PID_KEY);
  if (!id) {
    id = (Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,10)).toUpperCase();
    localStorage.setItem(PID_KEY, id);
  }
  return id;
}

function code(prefix){ return (prefix+"-"+Math.random().toString(36).slice(2,8)).toUpperCase(); }
const PLACEHOLDER="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAIAAfsBBQq1kTQAAAAASUVORK5CYII=";
function safeSet(imgEl, src){ imgEl.onerror = ()=>{ imgEl.src = PLACEHOLDER; }; imgEl.src = src; }

/* ======= Helpers fetch/timeout ======= */
async function getJSON(url, timeout=2200){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeout);
  try{
    const res = await fetch(url, { signal: controller.signal });
    return await res.json();
  }catch(e){
    return null; // tratamos como fallo de conexi√≥n/timeout
  }finally{ clearTimeout(t); }
}

/* ======= CUPOS ======= */
async function fetchQuota(){
  const url = `${PRIMARY_URL}?quota=1&player_id=${encodeURIComponent(getPlayerId())}`;
  const q = await getJSON(url, 2200);
  renderQuota(q);
}
function renderQuota(q){
  const el = $("#quotaText");
  if (q && Number.isFinite(q.limit) && Number.isFinite(q.used)) {
    const rem = (q.remaining!=null)? q.remaining : Math.max(0, q.limit - q.used);
    el.textContent = `Te quedan ${Math.max(0,rem)} de ${q.limit} giros hoy`;
  } else { el.textContent = ``; }
}

/* ======= RESERVA (no bloquear UI) ======= */
async function reserveSpin(){
  const force = qs.get("force")==="1" ? "&force=1" : "";
  const url = `${PRIMARY_URL}?reserve=1&player_id=${encodeURIComponent(getPlayerId())}${force}`;
  const r = await getJSON(url, 2500);
  if (!r) return { ok:false, allowed:false, reason:"reserve_failed" };
  return r;
}

/* ======= M√°quina ======= */
const r1=$("#r1"), r2=$("#r2"), r3=$("#r3"), msg=$("#resultMsg");
const spinBtn=$("#spinBtn");

function animateSpin(frames=18, cb){
  let i=0;
  const iv=setInterval(()=>{
    safeSet(r1, pick(FILLERS));
    safeSet(r2, pick(FILLERS));
    safeSet(r3, pick(FILLERS));
    if(++i>=frames){ clearInterval(iv); cb(); }
  },60);
}
function newEventId(){ return Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,8); }

function sendBackend(payload){
  const headers = { "Content-Type":"text/plain;charset=utf-8" }; // evita preflight
  const body = JSON.stringify(payload);
  try { fetch(PRIMARY_URL, { method:"POST", mode:"no-cors", headers, body }); } catch(e) {}
}
function registrar(eventId, matchCount, codigo, reserveToken){
  const base={
    event_id:eventId, reserve_token: reserveToken,
    version:VERSION, modo: qs.get("modo") || "basic",
    nombre_completo:getName()||"Sin nombre",
    empresario:qs.get("empresario") || "",
    nro_pedido_web:qs.get("pedido") || "",
    player_id:getPlayerId()
  };
  if(matchCount===0) return sendBackend({...base,resultado:"NO_GANO",codigo:codigo||""});
  if(matchCount===1) return sendBackend({...base,resultado:"GAN√ì",premio_clave:"DESC10",codigo});
  if(matchCount===2) return sendBackend({...base,resultado:"GAN√ì",premio_clave:"OBSEQ1",codigo});
  if(matchCount===3) return sendBackend({...base,resultado:"GAN√ì",premio_clave:"DESC50",codigo});
}

function buildFinalReels(){
  const count = chooseProductCount();
  const out = [];
  for(let i=0;i<count;i++) out.push({src: PRODUCT_IMAGE, type:'product'});
  for(let i=out.length;i<3;i++) out.push({src: pick(FILLERS), type:'filler'});
  // shuffle
  for(let i=out.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [out[i],out[j]]=[out[j],out[i]]; }
  return out;
}

async function onSpin(){
  if(!getName()){ showNameModal(); return; }
  spinBtn.disabled=true;
  msg.textContent="Girando...";

  const eventId = newEventId();
  const finalSet=buildFinalReels();

  // Reserva en paralelo
  const reserve = await reserveSpin();

  // Si la reserva falla por red/timeout ‚Üí NO consumimos jugada
  if (!reserve || reserve.ok===false) {
    animateSpin(12, ()=>{
      safeSet(r1, pick(FILLERS)); safeSet(r2, pick(FILLERS)); safeSet(r3, pick(FILLERS));
      msg.textContent = "Problemas de conexi√≥n. Int√©ntalo de nuevo.";
      spinBtn.disabled=false;
      fetchQuota();
    });
    return;
  }

  // Si el backend respondi√≥ pero NO permite girar (o no entreg√≥ token) ‚Üí l√≠mite
  if (reserve.allowed === false || !reserve.token){
    animateSpin(12, ()=>{
      safeSet(r1, pick(FILLERS)); safeSet(r2, pick(FILLERS)); safeSet(r3, pick(FILLERS));
      msg.textContent = "Alcanzaste tu l√≠mite de giros hoy.";
      spinBtn.disabled=false;
      fetchQuota();
    });
    return;
  }

  // Reserva OK ‚Üí terminamos animaci√≥n y registramos
  animateSpin(18, ()=>{
    safeSet(r1, finalSet[0].src);
    safeSet(r2, finalSet[1].src);
    safeSet(r3, finalSet[2].src);

    const productsOnScreen = finalSet.filter(x=>x.type==='product').length;
    let pText="", pCode="";
    if(productsOnScreen===0){
      msg.textContent="Sin premio, vuelve a intentarlo.";
      registrar(eventId,0,"", reserve.token);
    }else if(productsOnScreen===1){
      pText="10% de descuento en tu pr√≥xima compra"; pCode=code("YV10");
      $("#prizeText").textContent=pText; $("#prizeCode").textContent=pCode; $("#prizeDlg").showModal();
      msg.textContent="¬°Ganaste!"; registrar(eventId,1,pCode, reserve.token);
    }else if(productsOnScreen===2){
      pText="1 producto de obsequio por compras > $100.000 (no v√°lido para kits)"; pCode=code("OBSEQ1");
      $("#prizeText").textContent=pText; $("#prizeCode").textContent=pCode; $("#prizeDlg").showModal();
      msg.textContent="¬°Ganaste!"; registrar(eventId,2,pCode, reserve.token);
    }else{
      pText="50% de descuento en tu siguiente compra"; pCode=code("YV50");
      $("#prizeText").textContent=pText; $("#prizeCode").textContent=pCode; $("#prizeDlg").showModal();
      msg.textContent="¬°Ganaste!"; registrar(eventId,3,pCode, reserve.token);
    }

    setTimeout(fetchQuota, 800);
    spinBtn.disabled=false;
  });
}

/* ======= Eventos ======= */
document.addEventListener("DOMContentLoaded", ()=>{
  safeSet(r1, pick(FILLERS)); safeSet(r2, pick(FILLERS)); safeSet(r3, pick(FILLERS));
  paintName();

  $("#changeName").addEventListener("click", ()=>{ localStorage.removeItem(NAME_KEY); showNameModal(); });
  $("#saveName").addEventListener("click", ()=>{ setName($("#nameInput").value); $("#nameDlg").close(); fetchQuota(); });

  $("#closePrize").addEventListener("click", ()=> $("#prizeDlg").close());
  $("#spinBtn").addEventListener("click", onSpin);

  $("#shareBtn").addEventListener("click", async ()=>{
    const url=location.href;
    try{ if(navigator.share) await navigator.share({title:"Tragamonedas Yavalva",text:"¬°Gira y gana premios!",url});
         else navigator.clipboard && navigator.clipboard.writeText(url); }catch(e){}
  });

  // NUEVO: bot√≥n para ver/copiar el player_id
  $("#idBtn").addEventListener("click", async ()=>{
    const id = getPlayerId();
    try { await navigator.clipboard.writeText(id); } catch(e) {}
    alert("Tu player_id es:\n" + id + "\n(ya lo copi√© al portapapeles)");
  });

  fetchQuota();
});
</script>
</body>
</html>
